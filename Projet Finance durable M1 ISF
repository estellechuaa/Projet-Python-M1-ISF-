{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "516efb72-a973-4ed9-a06e-0b7ab3c1cd62",
   "metadata": {},
   "source": [
    "<div style=\"text-align: center; border: 2px solid #2E7D32; padding: 20px; border-radius: 10px; background-color: #f9fbf9;\">\n",
    "\n",
    "# Optimisation de portefeuille avec un objectif de réduction carbone\n",
    "### Projet Finance Durable\n",
    "\n",
    "---\n",
    "\n",
    "\n",
    "Sous la direction de : **Thierry Roncalli** & **Natasha Abou Rjaily**\n",
    "\n",
    "Année Universitaire 2025–2026\n",
    "\n",
    "Réalisé par :\n",
    "**Estelle Chua | Lucie Huang | Sylvia Shao**\n",
    "\n",
    "</div>\n",
    "\n",
    "---\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 75,
   "id": "b20068cc-2255-4218-9313-223d7f6e5694",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Packages\n",
    "import numpy as np \n",
    "np.set_printoptions(suppress=True) \n",
    "import cvxpy as cp \n",
    "import matplotlib.pyplot as plt\n",
    "import pandas as pd"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c9caba78-6736-42a0-bc8f-352f6cbc1143",
   "metadata": {},
   "source": [
    "Nous considérons un univers d'investissement de 8 émetteurs. Dans la table ci-dessous, nous reportons les émissions carbone $\\mathcal{CE}_{i,j}$ de l'entreprise $i$ pour le scope $j$ et leur revenu $Y_i$. Nous\n",
    "indiquons aussi dans la dernière ligne si l’entreprise appartient au secteur ${S}_{1}$ ou ${S}_{2}$\n",
    "| Entreprise | #1 | #2 | #3 | #4 | #5 | #6 | #7 | #8 |\n",
    "| :--- | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :---: |\n",
    "| $\\mathcal{CE}_{i,1}$ (ktCO$_2$e) | 75 | 5 000 | 720 | 50 | 2 500 | 25 | 30 000 | 5 |\n",
    "| $\\mathcal{CE}_{i,2}$ (ktCO$_2$e) | 75 | 5 000 | 1 030 | 350 | 4 500 | 5 | 2 000 | 64 |\n",
    "| $\\mathcal{CE}_{i,3}$ (ktCO$_2$e) | 200 | 500 | 520 | 850 | 8 000 | 50 | 200 | 146 |\n",
    "| $Y_i$ (en \\$ bn) | 300 | 328 | 125 | 100 | 200 | 102 | 107 | 25 |\n",
    "| **Secteur** | $\\mathcal{S}_1$ | $\\mathcal{S}_2$ | $\\mathcal{S}_1$ | $\\mathcal{S}_1$ | $\\mathcal{S}_2$ | $\\mathcal{S}_1$ | $\\mathcal{S}_2$ | $\\mathcal{S}_2$ |\n",
    "\n",
    "Nous supposons que la volatilité des rendements des actions de ces entreprises est respectivement égale à 12%, 21%, 23%, 19%, 20%, 33%, 43% and 19%. La matrice de corrélation entre les rendements de ces actions est égale à:\n",
    "$$\n",
    "\\rho = \\begin{pmatrix} \n",
    "100\\% & & & & & & & \\\\\n",
    "80\\% & 100\\% & & & & & & \\\\\n",
    "70\\% & 75\\% & 100\\% & & & & & \\\\\n",
    "60\\% & 65\\% & 80\\% & 100\\% & & & & \\\\\n",
    "70\\% & 50\\% & 70\\% & 85\\% & 100\\% & & & \\\\\n",
    "50\\% & 60\\% & 70\\% & 80\\% & 60\\% & 100\\% & & \\\\\n",
    "70\\% & 50\\% & 70\\% & 75\\% & 80\\% & 50\\% & 100\\% & \\\\\n",
    "70\\% & 75\\% & 80\\% & 85\\% & 75\\% & 80\\% & 70\\% & 100\\%\n",
    "\\end{pmatrix}\n",
    "$$\n",
    "\n",
    "Le portefeuille de référence (ou benchmark) b de cet univers d’investissement est défini par le vecteur d’allocation suivant:\n",
    "\n",
    "<center>$b = (20\\%, 17\\%, 17\\%, 13\\%, 11\\%, 10\\%, 6\\%, 6\\%)$</center>\n",
    "\n",
    "\n",
    "Dans ce qui suit, nous considérons uniquement des <u>**portefeuilles long-only**</u>.\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 76,
   "id": "18efd9d6-c08e-4e45-9b4c-a5dfa0fa9239",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Data\n",
    "#Volatilité\n",
    "sigma = np.array([12,21,23,19,20,33,43,19])/100 \n",
    "\n",
    "#Portefeuille de référence (Benchmark)\n",
    "b = np.array([20,17,17,13,11,10,6,6])/100\n",
    "\n",
    "#Émissions carbone\n",
    "CE = np.array([[75,5000,720,50,2500,25,30000,5],\n",
    "               [75, 5000, 1030, 350, 4500, 5, 2000, 64],\n",
    "               [200,500,520,850,8000,50,200,146]]) \n",
    "\n",
    "#Revenu\n",
    "Y = np.array([300,328,125,100,200,102,107,25])\n",
    "\n",
    "#Matrice de corrélation\n",
    "rho = np.array([[1.00, 0.80, 0.70, 0.60, 0.70, 0.50, 0.70, 0.70],\n",
    "               [0.80, 1.00, 0.75, 0.65, 0.50, 0.60, 0.50, 0.75],\n",
    "               [0.70, 0.75, 1.00, 0.80, 0.70, 0.70, 0.70, 0.80],\n",
    "               [0.60, 0.65, 0.80, 1.00, 0.85, 0.80, 0.75, 0.85],\n",
    "               [0.70, 0.50, 0.70, 0.85, 1.00, 0.60, 0.80, 0.75],\n",
    "               [0.50, 0.60, 0.70, 0.80, 0.60, 1.00, 0.50, 0.80],\n",
    "               [0.70, 0.50, 0.70, 0.75, 0.80, 0.50, 1.00, 0.70],\n",
    "               [0.70, 0.75, 0.80, 0.85, 0.75, 0.80, 0.70, 1.00]])\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "52efb01f-73d0-4d26-a28b-0dd680d47998",
   "metadata": {},
   "source": [
    "## **1. Nous voulons calculer l'intensité carbone du portefeuille de référence.**\n",
    "\n",
    "* **(a)** Déduire les émissions carbone $CE_{i, 1+2+3}$ de chaque entreprise $i$ pour les émissions scope $1+2+3$.\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 81,
   "id": "a270ed08-8ec9-4b83-9b14-a7ce47f2b61f",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Émissions totales</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>Entreprise 1</th>\n",
       "      <td>350</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 2</th>\n",
       "      <td>10500</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 3</th>\n",
       "      <td>2270</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 4</th>\n",
       "      <td>1250</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 5</th>\n",
       "      <td>15000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 6</th>\n",
       "      <td>80</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 7</th>\n",
       "      <td>32200</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 8</th>\n",
       "      <td>215</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "              Émissions totales\n",
       "Entreprise 1                350\n",
       "Entreprise 2              10500\n",
       "Entreprise 3               2270\n",
       "Entreprise 4               1250\n",
       "Entreprise 5              15000\n",
       "Entreprise 6                 80\n",
       "Entreprise 7              32200\n",
       "Entreprise 8                215"
      ]
     },
     "execution_count": 81,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "emission_par_ent = np.sum(CE, axis=0)\n",
    "\n",
    "# Transformation en dataframe\n",
    "entreprises = [f\"Entreprise {i+1}\" for i in range(CE.shape[1])]\n",
    "df = pd.DataFrame(emission_par_ent.reshape(-1,1),  \n",
    "                  index=entreprises,              \n",
    "                  columns=[\"Émissions totales\"]) \n",
    "df\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "01d18fee-a635-4527-a605-d4bcbec1cecd",
   "metadata": {},
   "source": [
    "* **(b)** En déduire les intensités carbone $CI_{i, 1+2+3}$ de chaque entreprise $i$ pour les émissions scope $1+2+3$."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 80,
   "id": "7b12c1c4-5f6f-404b-aea7-0bcf8f921e52",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>#1</th>\n",
       "      <th>#2</th>\n",
       "      <th>#3</th>\n",
       "      <th>#4</th>\n",
       "      <th>#5</th>\n",
       "      <th>#6</th>\n",
       "      <th>#7</th>\n",
       "      <th>#8</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>Scope 1 Intensity</th>\n",
       "      <td>0.25</td>\n",
       "      <td>15.24</td>\n",
       "      <td>5.76</td>\n",
       "      <td>0.5</td>\n",
       "      <td>12.5</td>\n",
       "      <td>0.25</td>\n",
       "      <td>280.37</td>\n",
       "      <td>0.20</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Scope 2 Intensity</th>\n",
       "      <td>0.25</td>\n",
       "      <td>15.24</td>\n",
       "      <td>8.24</td>\n",
       "      <td>3.5</td>\n",
       "      <td>22.5</td>\n",
       "      <td>0.05</td>\n",
       "      <td>18.69</td>\n",
       "      <td>2.56</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Scope 3 Intensity</th>\n",
       "      <td>0.67</td>\n",
       "      <td>1.52</td>\n",
       "      <td>4.16</td>\n",
       "      <td>8.5</td>\n",
       "      <td>40.0</td>\n",
       "      <td>0.49</td>\n",
       "      <td>1.87</td>\n",
       "      <td>5.84</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                     #1     #2    #3   #4    #5    #6      #7    #8\n",
       "Scope 1 Intensity  0.25  15.24  5.76  0.5  12.5  0.25  280.37  0.20\n",
       "Scope 2 Intensity  0.25  15.24  8.24  3.5  22.5  0.05   18.69  2.56\n",
       "Scope 3 Intensity  0.67   1.52  4.16  8.5  40.0  0.49    1.87  5.84"
      ]
     },
     "execution_count": 80,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "CI=CE/Y\n",
    "\n",
    "# Transformation en DataFrame\n",
    "labels_entreprises = [f'#{i}' for i in range(1, 9)]\n",
    "labels_scopes = ['Scope 1 Intensity', 'Scope 2 Intensity', 'Scope 3 Intensity']\n",
    "\n",
    "df_CI = pd.DataFrame(CI, columns=labels_entreprises, index=labels_scopes).round(2)\n",
    "df_CI"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 82,
   "id": "44cc3f49-e5d4-4584-b7ca-452c655c08bd",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>#1</th>\n",
       "      <th>#2</th>\n",
       "      <th>#3</th>\n",
       "      <th>#4</th>\n",
       "      <th>#5</th>\n",
       "      <th>#6</th>\n",
       "      <th>#7</th>\n",
       "      <th>#8</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>Scope 1 Intensity</th>\n",
       "      <td>0.25</td>\n",
       "      <td>15.24</td>\n",
       "      <td>5.76</td>\n",
       "      <td>0.5</td>\n",
       "      <td>12.5</td>\n",
       "      <td>0.25</td>\n",
       "      <td>280.37</td>\n",
       "      <td>0.20</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Scope 1+2 Intensity</th>\n",
       "      <td>0.50</td>\n",
       "      <td>30.49</td>\n",
       "      <td>14.00</td>\n",
       "      <td>4.0</td>\n",
       "      <td>35.0</td>\n",
       "      <td>0.29</td>\n",
       "      <td>299.07</td>\n",
       "      <td>2.76</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Scope 1+2+3 Intensity</th>\n",
       "      <td>1.17</td>\n",
       "      <td>32.01</td>\n",
       "      <td>18.16</td>\n",
       "      <td>12.5</td>\n",
       "      <td>75.0</td>\n",
       "      <td>0.78</td>\n",
       "      <td>300.93</td>\n",
       "      <td>8.60</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                         #1     #2     #3    #4    #5    #6      #7    #8\n",
       "Scope 1 Intensity      0.25  15.24   5.76   0.5  12.5  0.25  280.37  0.20\n",
       "Scope 1+2 Intensity    0.50  30.49  14.00   4.0  35.0  0.29  299.07  2.76\n",
       "Scope 1+2+3 Intensity  1.17  32.01  18.16  12.5  75.0  0.78  300.93  8.60"
      ]
     },
     "execution_count": 82,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "CI_sum=np.cumsum(CI,axis=0)\n",
    "\n",
    "# Transformation en DataFrame\n",
    "labels_entreprises = [f'#{i}' for i in range(1, 9)]\n",
    "labels_cumul = ['Scope 1 Intensity', 'Scope 1+2 Intensity', 'Scope 1+2+3 Intensity']\n",
    "\n",
    "df_CI_sum = pd.DataFrame(CI_sum, columns=labels_entreprises, index=labels_cumul).round(2)\n",
    "df_CI_sum"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "359d1ec3-d3a4-4567-b5d3-b77321fa7dc3",
   "metadata": {},
   "source": [
    "* **(c)** Calculer l'intensité carbone pondérée (ou WACI) du benchmark.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 83,
   "id": "7f42cb05-0df6-4a8a-b08f-fd1df386c4c0",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "37.288112642969196\n"
     ]
    }
   ],
   "source": [
    "CI_123=CI_sum[2,:] ##la somme des lignes 1,2,3. 2 pour le 2e indice car départ à 0 en python et : pour sélectionner la ligne\n",
    "WACI_b=np.sum(CI_123*b)\n",
    "#carbon intensity (WACI) of the benchmark\n",
    "print(WACI_b)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "41b30f40-2be1-405d-9c9e-320adcb4b57f",
   "metadata": {},
   "source": [
    "---\n",
    "\n",
    "## **2. Nous voulons gérer un portefeuille actions basé sur l'univers d'investissement précédent et réduire la mesure **WACI** du benchmark par un taux de réduction $\\mathcal{R}$.**\n",
    "\n",
    "\n",
    "* **(a)** Calculer la matrice de covariance $\\Sigma$.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 84,
   "id": "5ce6c76f-0a25-4a0f-8676-5c3c4e7abd31",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Matrice de covariance Σ\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>#1</th>\n",
       "      <th>#2</th>\n",
       "      <th>#3</th>\n",
       "      <th>#4</th>\n",
       "      <th>#5</th>\n",
       "      <th>#6</th>\n",
       "      <th>#7</th>\n",
       "      <th>#8</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>#1</th>\n",
       "      <td>0.014</td>\n",
       "      <td>0.020</td>\n",
       "      <td>0.019</td>\n",
       "      <td>0.014</td>\n",
       "      <td>0.017</td>\n",
       "      <td>0.020</td>\n",
       "      <td>0.036</td>\n",
       "      <td>0.016</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#2</th>\n",
       "      <td>0.020</td>\n",
       "      <td>0.044</td>\n",
       "      <td>0.036</td>\n",
       "      <td>0.026</td>\n",
       "      <td>0.021</td>\n",
       "      <td>0.042</td>\n",
       "      <td>0.045</td>\n",
       "      <td>0.030</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#3</th>\n",
       "      <td>0.019</td>\n",
       "      <td>0.036</td>\n",
       "      <td>0.053</td>\n",
       "      <td>0.035</td>\n",
       "      <td>0.032</td>\n",
       "      <td>0.053</td>\n",
       "      <td>0.069</td>\n",
       "      <td>0.035</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#4</th>\n",
       "      <td>0.014</td>\n",
       "      <td>0.026</td>\n",
       "      <td>0.035</td>\n",
       "      <td>0.036</td>\n",
       "      <td>0.032</td>\n",
       "      <td>0.050</td>\n",
       "      <td>0.061</td>\n",
       "      <td>0.031</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#5</th>\n",
       "      <td>0.017</td>\n",
       "      <td>0.021</td>\n",
       "      <td>0.032</td>\n",
       "      <td>0.032</td>\n",
       "      <td>0.040</td>\n",
       "      <td>0.040</td>\n",
       "      <td>0.069</td>\n",
       "      <td>0.029</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#6</th>\n",
       "      <td>0.020</td>\n",
       "      <td>0.042</td>\n",
       "      <td>0.053</td>\n",
       "      <td>0.050</td>\n",
       "      <td>0.040</td>\n",
       "      <td>0.109</td>\n",
       "      <td>0.071</td>\n",
       "      <td>0.050</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#7</th>\n",
       "      <td>0.036</td>\n",
       "      <td>0.045</td>\n",
       "      <td>0.069</td>\n",
       "      <td>0.061</td>\n",
       "      <td>0.069</td>\n",
       "      <td>0.071</td>\n",
       "      <td>0.185</td>\n",
       "      <td>0.057</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>#8</th>\n",
       "      <td>0.016</td>\n",
       "      <td>0.030</td>\n",
       "      <td>0.035</td>\n",
       "      <td>0.031</td>\n",
       "      <td>0.029</td>\n",
       "      <td>0.050</td>\n",
       "      <td>0.057</td>\n",
       "      <td>0.036</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "       #1     #2     #3     #4     #5     #6     #7     #8\n",
       "#1  0.014  0.020  0.019  0.014  0.017  0.020  0.036  0.016\n",
       "#2  0.020  0.044  0.036  0.026  0.021  0.042  0.045  0.030\n",
       "#3  0.019  0.036  0.053  0.035  0.032  0.053  0.069  0.035\n",
       "#4  0.014  0.026  0.035  0.036  0.032  0.050  0.061  0.031\n",
       "#5  0.017  0.021  0.032  0.032  0.040  0.040  0.069  0.029\n",
       "#6  0.020  0.042  0.053  0.050  0.040  0.109  0.071  0.050\n",
       "#7  0.036  0.045  0.069  0.061  0.069  0.071  0.185  0.057\n",
       "#8  0.016  0.030  0.035  0.031  0.029  0.050  0.057  0.036"
      ]
     },
     "execution_count": 84,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "labels = [f'#{i}' for i in range(1, 9)]\n",
    "covmatrix=np.diag(sigma) @ rho @ np.diag(sigma)\n",
    "\n",
    "# Transformation en DataFrame\n",
    "df_cov = pd.DataFrame(covmatrix, columns=labels, index=labels).round(3)\n",
    "print(\"Matrice de covariance Σ\")\n",
    "df_cov\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4ea38920-0249-4275-b52f-deea172e8bc3",
   "metadata": {},
   "source": [
    "* **(b)** Écrire le problème d'optimisation si l'objectif est de minimiser le risque d'erreur de réplication (tracking error) sous la contrainte de réduction de l'intensité carbone.\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 85,
   "id": "0065a07c-14b3-459d-bb3e-f5060f7aad77",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Les poids optimaux sont: [0.2  0.17 0.17 0.13 0.11 0.1  0.06 0.06]\n",
      "\n",
      "Le seuil de CI maximum est: 37.288112642969196\n",
      "\n",
      "Le tracking error est: 4.484548393292871e-12\n"
     ]
    }
   ],
   "source": [
    "#reduc= taux de réduction à définir\n",
    "reduc=0\n",
    "n=covMatrix.shape[0] #nb d'actifs\n",
    "w=cp.Variable(n)\n",
    "Q=covMatrix\n",
    "R=np.matmul(Q,b)\n",
    "A=np.ones(n)\n",
    "B=1 \n",
    "CI_score=CI_123  #scope 123  CI_123 et pas juste 1,2 CI_sum[1,:]car question d)\n",
    "C = CI_score\n",
    "WACI_b=np.sum(CI_score*b)\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "prob=cp.Problem(cp.Minimize(0.5 * cp.quad_form(w - b, Q)),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "\n",
    "w_optim=w.value\n",
    "w0=w_optim\n",
    "D0=D\n",
    "TE_variance0 = (w0 - b).T @ Q @ (w0 - b)\n",
    "TE_std_dev0 = np.sqrt(TE_variance0)\n",
    "print(\"Les poids optimaux sont:\",w0)\n",
    "print(\"\\nLe seuil de CI maximum est:\", D0)\n",
    "print(\"\\nLe tracking error est:\", TE_std_dev0)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "9d07d490-c582-455b-8ba6-002f881471a5",
   "metadata": {},
   "source": [
    "* **(c)** Donner la formulation **QP (quadratic programming)** de ce problème d'optimisation.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 88,
   "id": "92afecdd-e385-4b1b-8254-5ae37c2511cc",
   "metadata": {},
   "outputs": [],
   "source": [
    "w=cp.Variable(n)\n",
    "n=covMatrix.shape[0] #nb d'actifs\n",
    "Q=covMatrix\n",
    "R=np.matmul(Q,b)\n",
    "A=np.ones(n)\n",
    "B=1 \n",
    "CI_score=CI_123 #scope 123  CI_123 et pas juste 1,2 CI_sum[1,:] car question d)\n",
    "C = CI_score\n",
    "WACI_b = np.sum(b*CI_score) #Attention à bien définir le WACI_b sur les scopes 123 Ici CI_score=CI_123 donc OK \n",
    "# et On garde le même WACI_b pour les autres R donc pas besoin de renommer\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "w=cp.Variable(n)\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w, Q)- w.T @ R),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "w1=w.value"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "83a0644b-eec7-48e7-91a3-196e0e37bd52",
   "metadata": {},
   "source": [
    "* **(d)** $\\mathcal{R}$ est égal à **20%**. Trouver le portefeuille optimal si nous ciblons les scopes $1+2+3$. Quelle est la volatilité de l'erreur de réplication ?\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 89,
   "id": "65f998ea-4ca6-476c-a566-7c93ea8d6c40",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Les poids optimaux sont: [0.22857078 0.1345373  0.18491269 0.16516332 0.0693055  0.09712221\n",
      " 0.04626551 0.07412268]\n",
      "\n",
      "Le seuil de CI maximum est: 29.83049011437536\n",
      "\n",
      "Le tracking error est: 0.006254085778657727\n"
     ]
    }
   ],
   "source": [
    "reduc=0.2\n",
    "w=cp.Variable(n)\n",
    "n=covMatrix.shape[0] #nb d'actifs\n",
    "Q=covMatrix\n",
    "R=np.matmul(Q,b)\n",
    "A=np.ones(n)\n",
    "B=1 \n",
    "CI_score=CI_123 #scope 123  CI_123 et pas juste 1,2 CI_sum[1,:] car question d)\n",
    "C = CI_score\n",
    "WACI_b = np.sum(b*CI_score) #Attention à bien définir le WACI_b sur les scopes 123 Ici CI_score=CI_123 donc OK \n",
    "# et On garde le même WACI_b pour les autres R donc pas besoin de renommer\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "w=cp.Variable(n)\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w, Q)- w.T @ R),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "w1=w.value\n",
    "print(\"Les poids optimaux sont:\", w1)\n",
    "# Question d\n",
    "D1=D\n",
    "TE_variance1 = (w1 - b).T @ Q @ (w1 - b)\n",
    "TE_std_dev1 = np.sqrt(TE_variance1)\n",
    "TE_std_dev1\n",
    "print(\"\\nLe seuil de CI maximum est:\", D1)\n",
    "print(\"\\nLe tracking error est:\", TE_std_dev1)\n",
    "#sachant que 1%=1bps"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "98e8b4b5-5342-41d2-bc6b-6a453f1725ff",
   "metadata": {},
   "source": [
    "* **(e)** Même question si $\\mathcal{R}$ est égal à **30%**, **50%**, et **70%**.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 90,
   "id": "9c26be53-d1b8-4260-ab6f-3be6c9d2ff89",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Les poids optimaux sont: [0.24285617 0.11680595 0.19236903 0.18274498 0.04895824 0.09568332\n",
      " 0.03939827 0.08118402]\n",
      "\n",
      "Le seuil de CI maximum est: 26.101678850078436\n",
      "\n",
      "Le tracking error est: 0.009381128667986582\n"
     ]
    }
   ],
   "source": [
    "#avec 30%\n",
    "reduc=0.3\n",
    "\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "w=cp.Variable(n)\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w, Q)- w.T @ R),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "w2=w.value\n",
    "D2=D\n",
    "\n",
    "TE_variance2 = (w2 - b).T @ Q @ (w2 - b)\n",
    "TE_std_dev2 = np.sqrt(TE_variance2)\n",
    "\n",
    "print(\"Les poids optimaux sont:\",w2)\n",
    "print(\"\\nLe seuil de CI maximum est:\", D2)\n",
    "print(\"\\nLe tracking error est:\", TE_std_dev2)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "id": "0b6899f0-1cb5-4d93-930d-0ffb824987cc",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Les poids optimaux sont: [0.27142695 0.08134326 0.20728172 0.21790831 0.00826374 0.09280554\n",
      " 0.02566378 0.0953067 ]\n",
      "\n",
      "Le seuil de CI maximum est: 18.644056321484598\n",
      "\n",
      "Le tracking error est: 0.015635214446644282\n"
     ]
    }
   ],
   "source": [
    "#avec 50%\n",
    "reduc=0.5\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "w=cp.Variable(n)\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w, Q)- w.T @ R),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "w3=w.value\n",
    "D3=D\n",
    "TE_variance3 = (w3 - b).T @ Q @ (w3 - b)\n",
    "TE_std_dev3 = np.sqrt(TE_variance3)\n",
    "\n",
    "print(\"Les poids optimaux sont:\",w3)\n",
    "print(\"\\nLe seuil de CI maximum est:\", D3)\n",
    "print(\"\\nLe tracking error est:\", TE_std_dev3)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 92,
   "id": "c87c915e-01bb-4444-b6ca-db86ea787a57",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Les poids optimaux sont: [0.28545089 0.05197778 0.22519407 0.2331859  0.         0.09139902\n",
      " 0.0039114  0.10888094]\n",
      "\n",
      "Le seuil de CI maximum est: 11.18643379289076\n",
      "\n",
      "Le tracking error est: 0.022076080507686512\n"
     ]
    }
   ],
   "source": [
    "#avec 70%\n",
    "reduc=0.7\n",
    "D = (1-reduc)*WACI_b\n",
    "\n",
    "w=cp.Variable(n)\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w, Q)- w.T @ R),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "w4=w.value\n",
    "D4=D\n",
    "\n",
    "TE_variance4 = (w4 - b).T @ Q @ (w4 - b)\n",
    "TE_std_dev4 = np.sqrt(TE_variance4)\n",
    "\n",
    "print(\"Les poids optimaux sont:\",w4)\n",
    "print(\"\\nLe seuil de CI maximum est:\", D4)\n",
    "print(\"\\nLe tracking error est:\", TE_std_dev4)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 94,
   "id": "496eccad-6a8e-47e7-b1e0-d03496cbb659",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>0%</th>\n",
       "      <th>20%</th>\n",
       "      <th>30%</th>\n",
       "      <th>50%</th>\n",
       "      <th>70%</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>w1</th>\n",
       "      <td>20.0000</td>\n",
       "      <td>22.8571</td>\n",
       "      <td>24.2856</td>\n",
       "      <td>27.1427</td>\n",
       "      <td>28.5451</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w2</th>\n",
       "      <td>17.0000</td>\n",
       "      <td>13.4537</td>\n",
       "      <td>11.6806</td>\n",
       "      <td>8.1343</td>\n",
       "      <td>5.1978</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w3</th>\n",
       "      <td>17.0000</td>\n",
       "      <td>18.4913</td>\n",
       "      <td>19.2369</td>\n",
       "      <td>20.7282</td>\n",
       "      <td>22.5194</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w4</th>\n",
       "      <td>13.0000</td>\n",
       "      <td>16.5163</td>\n",
       "      <td>18.2745</td>\n",
       "      <td>21.7908</td>\n",
       "      <td>23.3186</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w5</th>\n",
       "      <td>11.0000</td>\n",
       "      <td>6.9305</td>\n",
       "      <td>4.8958</td>\n",
       "      <td>0.8264</td>\n",
       "      <td>0.0000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w6</th>\n",
       "      <td>10.0000</td>\n",
       "      <td>9.7122</td>\n",
       "      <td>9.5683</td>\n",
       "      <td>9.2806</td>\n",
       "      <td>9.1399</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w7</th>\n",
       "      <td>6.0000</td>\n",
       "      <td>4.6266</td>\n",
       "      <td>3.9398</td>\n",
       "      <td>2.5664</td>\n",
       "      <td>0.3911</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>w8</th>\n",
       "      <td>6.0000</td>\n",
       "      <td>7.4123</td>\n",
       "      <td>8.1184</td>\n",
       "      <td>9.5307</td>\n",
       "      <td>10.8881</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>CI(w)</th>\n",
       "      <td>37.2881</td>\n",
       "      <td>29.8305</td>\n",
       "      <td>26.1017</td>\n",
       "      <td>18.6441</td>\n",
       "      <td>11.1864</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>σ(w | b)</th>\n",
       "      <td>0.0000</td>\n",
       "      <td>0.0063</td>\n",
       "      <td>0.0094</td>\n",
       "      <td>0.0156</td>\n",
       "      <td>0.0221</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "               0%      20%      30%      50%      70%\n",
       "w1        20.0000  22.8571  24.2856  27.1427  28.5451\n",
       "w2        17.0000  13.4537  11.6806   8.1343   5.1978\n",
       "w3        17.0000  18.4913  19.2369  20.7282  22.5194\n",
       "w4        13.0000  16.5163  18.2745  21.7908  23.3186\n",
       "w5        11.0000   6.9305   4.8958   0.8264   0.0000\n",
       "w6        10.0000   9.7122   9.5683   9.2806   9.1399\n",
       "w7         6.0000   4.6266   3.9398   2.5664   0.3911\n",
       "w8         6.0000   7.4123   8.1184   9.5307  10.8881\n",
       "CI(w)     37.2881  29.8305  26.1017  18.6441  11.1864\n",
       "σ(w | b)   0.0000   0.0063   0.0094   0.0156   0.0221"
      ]
     },
     "execution_count": 94,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "data = {\n",
    "    '0%': w0,\n",
    "    '20%': w1,\n",
    "    '30%': w2,\n",
    "    '50%': w3,\n",
    "    '70%': w4\n",
    "}\n",
    "\n",
    "#Transformation en dataframe\n",
    "df = pd.DataFrame(data)\n",
    "\n",
    "entreprises_labels = [f\"w{i+1}\" for i in range(len(w0))]\n",
    "df = df * 100\n",
    "\n",
    "df.index = entreprises_labels\n",
    "df.loc['CI(w)'] = [D0, D1, D2, D3, D4]\n",
    "df.loc['σ(w | b)'] = [TE_std_dev0, TE_std_dev1, TE_std_dev2, TE_std_dev3, TE_std_dev4]\n",
    "\n",
    "df_final = df.round(4)\n",
    "df_final\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "84450663-4a3e-4874-97a7-64596e0de376",
   "metadata": {},
   "source": [
    "## **3. On suppose que nous voulons gérer un portefeuille actions basé sur l'univers d'investissement précédent, réduire la mesure **WACI** du benchmark par un taux de réduction $\\mathcal{R}$ et être **secteur neutre**$^1$ (sector neutral). Écrire la contrainte secteur neutre sous forme matricielle.**\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 95,
   "id": "f568c410-aaf3-4974-8cef-a6213052b217",
   "metadata": {},
   "outputs": [],
   "source": [
    "n=covMatrix.shape[0] #nb d'actifs\n",
    "Q=covMatrix\n",
    "R=np.matmul(Q,b)\n",
    "A=np.ones(n)\n",
    "B=1 \n",
    "CI_score=CI_sum[2,:]\n",
    "réduc = 0.20\n",
    "C = CI_score\n",
    "D = (1-réduc)*WACI_b\n",
    "S = np.array([[1, 0, 1, 1, 0, 1, 0, 0],\n",
    "              [0, 1, 0, 0, 1, 0, 1, 1]])\n",
    "\n",
    "prob=cp.Problem(cp.Minimize((1/2)*cp.quad_form(w,Q)- R.T @ w),\n",
    "                [A @ w == B,\n",
    "                 C @ w <= D,\n",
    "                 S @ w == S @ b, #contrainte secteur neutre \n",
    "                 w >= 0,\n",
    "                 w <= 1])\n",
    "prob.solve()\n",
    "\n",
    "w_optim=w.value\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 96,
   "id": "25f9176a-eee5-4a3f-b25c-1dce282afb78",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Poids (%)</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>Entreprise 1</th>\n",
       "      <td>19.46</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 2</th>\n",
       "      <td>15.17</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 3</th>\n",
       "      <td>17.94</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 4</th>\n",
       "      <td>13.49</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 5</th>\n",
       "      <td>10.02</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 6</th>\n",
       "      <td>9.11</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 7</th>\n",
       "      <td>3.74</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>Entreprise 8</th>\n",
       "      <td>11.07</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "              Poids (%)\n",
       "Entreprise 1      19.46\n",
       "Entreprise 2      15.17\n",
       "Entreprise 3      17.94\n",
       "Entreprise 4      13.49\n",
       "Entreprise 5      10.02\n",
       "Entreprise 6       9.11\n",
       "Entreprise 7       3.74\n",
       "Entreprise 8      11.07"
      ]
     },
     "execution_count": 96,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "#Afficher le tableau\n",
    "poids_pourcentage = w_optim * 100\n",
    "entreprises = [f\"Entreprise {i+1}\" for i in range(len(w_optim))]\n",
    "df_w_optim = pd.DataFrame({\n",
    "    'Poids (%)': poids_pourcentage\n",
    "}, index=entreprises).round(2)\n",
    "df_w_optim\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d83867c9-a9d2-4fd2-92f1-c5cf8e99467c",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.2"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
